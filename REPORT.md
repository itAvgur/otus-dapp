## Быстрая справка

- Базовый публичный Esplora (testnet): `https://blockstream.info/testnet/api`
- Требование: Node.js >= 18 (скрипты используют глобальный `fetch`).
- Логирование и результаты печатаются в stdout в виде pretty JSON.

---

## Примеры быстрых запросов (curl)

Получить высоту цепочки (tip height):

```bash
curl https://blockstream.info/testnet/api/blocks/tip/height
# -> 4837058
```

Получить метаданные блока по хэшу:

```bash
curl https://blockstream.info/testnet/api/block/000000000000013d98a53b57a091c7637ca0cfb78f895436e9075f97bc596a72 | jq
```

Пример ответа (сокращённо):

```json
{
  "id": "000000000000013d...6a72",
  "height": 4837058,
  "timestamp": 1769343024,
  "tx_count": 6,
  "size": 1613
}
```

Получить состояние mempool (обзор):

```bash
curl https://blockstream.info/testnet/api/mempool
# -> {"count":13, "vsize":..., "total_fee":...}
```

---

## Общие особенности скриптов

- Оба скрипта используют глобальный `fetch` и вспомогательную функцию `fetchWithRetry(url, opts)` с таймаутом (по умолчанию 15s) и попытками с экспоненциальным бэкоффом (по умолчанию 3 попытки).
- Логирование: все служебные сообщения выводятся как JSON-объекты в stdout (поля `level`, `time`, `message`, ...). Финальные результаты — pretty-printed JSON.
- По умолчанию используется `ESPLORA_API = https://blockstream.info/testnet/api`. Можно переопределить `ESPLORA_API`, но скрипты валидируют значение: оно должно содержать слово `testnet` (защита от случайного вызова mainnet).

---

## `scripts/esplora-client.js`

### Назначение

Получить информацию о последнем блоке (высота, хэш), метаданные блока (время, число транзакций, размер) и все полные транзакции блока.

### Используемые эндпоинты

- `GET /blocks/tip/height` — текущая высота (число)
- `GET /blocks/tip/hash` — хэш последнего блока (строка)
- `GET /block/{hash}` — метаданные блока
- `GET /block/{hash}/txs` и `GET /block/{hash}/txs/{start}` — страницы транзакций блока (страница ≈ 25 tx)

### Логика

1. Берёт высоту и хэш tip.
2. Запрашивает метаданные блока через `/block/{hash}`.
3. Скачивает полные транзакции страницы за страницей: сначала `/block/{hash}/txs`, затем `/block/{hash}/txs/25`, `/block/{hash}/txs/50` и т.д., пока размер страницы < PAGE_SIZE.
4. Логирует прогресс и в конце выводит один JSON-объект:

```json
{
  "height": 4837063,
  "hash": "000000000000003e06970720b5a36d82fcc03c0c3cbe28c1a77ba55618e28e22",
  "meta": { "id": "000000000000003e06970720b5a36d82fcc03c0c3cbe28c1a77ba55618e28e22", "height": 4837063, "timestamp": 1769344584, "tx_count": 29, "size": 8246 },
  "txs": [
    { "txid": "d9bec0a96bb4150319892dcbeeb2354d4d401a6b0680d36fae17eaf0c574489a", "size": 234 },
    { "txid": "5f65da435a881392d381339bb06cda56824dac2b50e8acde6aca074dea902bb0", "size": 283 }
  ]
}
```

### Ограничения и замечания

- Требует Node 18+. При отсутствии глобального `fetch` скрипт завершится с кодом 2 с подсказкой об апгрейде/поллифиле.
- Для блоков с очень большим числом транзакций скрипт собирает все tx в память и выводит их одним JSON-объектом — возможны повышенные требования по памяти и объёму stdout.
- Скрипт сравнивает число загруженных транзакций с `meta.tx_count` и выводит предупреждение при расхождении.

---

## `scripts/check-payments.js`

### Назначение

Проверить входящие платежи на указанном testnet-адресе и вывести для каждого найденного платежа: сумма (сатоши и BTC), хэш транзакции (txid) и число подтверждений.

### Используемые эндпоинты

- `GET /blocks/tip/height` — текущая высота цепочки.
- `GET /address/{address}/txs` — первая страница confirmed транзакций для адреса.
- `GET /address/{address}/txs/mempool` — (опционально) транзакции в мемпуле для адреса, если API поддерживает.

### Логика

1. Берёт текущую высоту цепочки (tip).
2. Запрашивает первую страницу подтверждённых транзакций для адреса (`/address/{address}/txs`).
3. Пытается запросить мемпул `/address/{address}/txs/mempool` (если поддерживается API).
4. Для каждой транзакции суммирует значения `vout.value` только тех выходов, где `vout.scriptpubkey_address === <address>` — это входящая сумма для адреса.
5. Вычисляет подтверждения: если tx подтверждён и есть `status.block_height`, то `confirmations = tip - block_height + 1`, иначе `confirmations = 0`.
6. Выводит финальный объект:

```json
{
  "address": "tb1qnjvttgnl0gkxn99gmsd8g8zzpe7nckssmy56hu",
  "tip_height": 4837064,
  "payments": [
    { "txid": "8e616d9a0500b5749fc415578ff52b8d7de91707f028e7569cf54542bddddfe6", "amount_sats": 25968, "amount_btc": "0.00025968", "confirmations": 28 },
    { "txid": "6810d959e31ecd029c5f231a5addcfb14b558639f139b42af1e956f073881908", "amount_sats": 12885, "amount_btc": "0.00012885", "confirmations": 27 }
  ]
}
```

### Ограничения и замечания

- Скрипт не индексирует полную историю адреса (только первую страницу confirmed txs). Для полного охвата истории нужен Esplora с поддержкой пагинации по адресу или собственный индексатор (обход блоков).
- Не учитываются выходы, где Esplora не возвращает поле `scriptpubkey_address` — такие выходы не будут суммированы.

---

## Примеры запуска

Запустить `esplora-client` (последний блок и все tx):

```bash
node scripts/esplora-client.js
```

Проверить входящие платежи для адреса:

```bash
node scripts/check-payments.js tb1qnjvttgnl0gkxn99gmsd8g8zzpe7nckssmy56hu
```

С указанием кастомного Esplora API (строка должна содержать `testnet`):

```bash
ESPLORA_API="https://blockstream.info/testnet/api" node scripts/check-payments.js <address>
```

---

## Предложения по улучшению

- Добавить опцию `--out-file <path>` для сохранения результата в файл (удобно при больших объёмах данных).
- Добавить опцию потокового вывода (JSON-lines) для уменьшения пикового потребления памяти и удобства постобработки.
- Реализовать аккуратную пагинацию адресов: попробовать `/address/{address}/txs/{start}` и при получении 404 — остановиться (чтобы поддержать как сервера с пагинацией, так и без неё).
- Добавить unit-тесты с моками для `fetchWithRetry` и `extractIncomingAmount`.
